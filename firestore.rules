rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE SEGURIDAD CORREGIDAS ---
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'vallecondo@gmail.com';
    }

    // AHORA BUSCA EN OWNERS: Verifica si el usuario está en owners y su campo 'role' es 'admin'
    function isCondoAdmin(condoId) {
      let userDoc = get(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid));
      return request.auth != null && userDoc.data.role == 'admin';
    }

    function isCondoOwner(condoId) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid));
    }

    // --- REGLA MAESTRA SUPER ADMIN ---
    match /{allPaths=**} {
      allow read, write: if isSuperAdmin();
    }

    // --- COLECCIÓN DE CONDOMINIOS ---
    match /condominios/{condoId} {
      
      allow read: if request.auth != null;

      // Simplificamos la lectura de perfiles
      match /owners/{ownerId} {
        // Un usuario puede leer su propio perfil si está en owners (sea admin u owner)
        allow read: if request.auth != null && (request.auth.uid == ownerId || isCondoAdmin(condoId));
        // Solo admins pueden crear/editar perfiles
        allow write: if isCondoAdmin(condoId);
      }

      // DEUDAS (Debts)
      match /debts/{debtId} {
        allow read: if isCondoAdmin(condoId) || (request.auth != null && resource.data.ownerId == request.auth.uid);
        allow write: if isCondoAdmin(condoId);
      }

      // PAGOS (Payments)
      match /payments/{paymentId} {
        allow read: if isCondoAdmin(condoId) || (request.auth != null && request.auth.uid in resource.data.beneficiaryIds);
        allow create: if request.auth != null; 
        allow update, delete: if isCondoAdmin(condoId);
      }

      // CARTELERA (Billboard)
      match /billboard_announcements/{annId} {
        allow read: if request.auth != null; 
        allow write: if isCondoAdmin(condoId);
      }

      // CONFIGURACIÓN (Rooted en workingCondoId/activeCondoId)
      match /{allChildren=**} {
        allow read: if isCondoAdmin(condoId) || isCondoOwner(condoId);
        allow write: if isCondoAdmin(condoId);
      }
    }
  }
}
