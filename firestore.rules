rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ADMIN-ONLY RULES
    match /config/{docId} {
      allow read, write: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

    match /custom_documents/{docId} {
       allow read, write: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

    match /certificates/{docId} {
      allow read, write: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

     match /petty_cash_replenishments/{docId} {
      allow read, write: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }
    
    // OWNER-ACCESSIBLE RULES
    match /owners/{ownerId} {
      // Owners can read and write their own profile
      allow read, update: if request.auth != null && request.auth.uid == ownerId;
      // Admins can read, create, and update any owner profile
      allow read, create, update: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
      // Only admins can delete profiles (for now, restricted)
      allow delete: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

    match /payments/{paymentId} {
       // Owners can create payments (report them)
       allow create: if request.auth != null;
       // Owners can read payments where they are a beneficiary
       allow read: if request.auth != null && resource.data.beneficiaryIds.hasAny([request.auth.uid]);
       // Admins can read, update (approve/reject), and delete any payment
       allow read, update, delete: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }
    
    match /debts/{debtId} {
      // Owners can read their own debts
      allow read: if request.auth != null && resource.data.ownerId == request.auth.uid;
      // Admins can manage all debts
      allow read, create, update, delete: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

     match /historical_payments/{paymentId} {
        // Owners can read their own historical payments
        allow read: if request.auth != null && resource.data.ownerId == request.auth.uid;
        // Admins can manage all historical payments
        allow read, create, delete: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
     }

     match /published_reports/{reportId} {
        // All authenticated users can read published reports
        allow read: if request.auth != null;
        // Only admins can create/update them
        allow write: if get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
     }
  }
}
