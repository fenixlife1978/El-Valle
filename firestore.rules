rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAdmin() {
      // Check for admin role in the user's custom claims.
      // This requires setting custom claims via a backend function when a user is created or their role changes.
      // For simplicity in this context, we check a field in the user's profile.
      // A more secure approach is using custom claims: return request.auth.token.role == 'administrador';
      return get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'administrador';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAuthenticated() {
      return request.auth.uid != null;
    }

    // `owners` collection
    match /owners/{userId} {
      // Admins can read all profiles. Users can only read their own.
      allow read: if isAdmin() || isOwner(userId);
      // Admins can create/update/delete any profile. Users can only update their own.
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || isOwner(userId);
    }

    // `payments` and `debts` collections
    match /{collection}/{docId} where collection in ['payments', 'debts'] {
        // Admins can read all. Users can only read their own.
        // This rule is more complex to cover both debts (ownerId) and payments (beneficiaries array).
        allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.ownerId == request.auth.uid) || 
                    (isAuthenticated() && resource.data.beneficiaries[0].ownerId == request.auth.uid) ||
                    (isAuthenticated() && request.auth.uid in resource.data.beneficiaries.map(b => b.ownerId));

        // Admins can do anything. Users can only create.
        allow write: if isAdmin();
        allow create: if isAuthenticated();
    }

    // `config` and `historical_payments` collections
    match /{collection}/{docId} where collection in ['config', 'historical_payments'] {
      // Only admins can read or write to these critical collections.
      allow read, write: if isAdmin();
    }
  }
}
