rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
        return isSignedIn() && request.auth.token.email == 'vallecondo@gmail.com';
    }

    function isAdmin(condoId) {
      // Checks if the requesting user is an admin of the specified condo
      return isSignedIn() && get(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid)).data.role == 'administrador';
    }

    function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
    }

    // --- Root Collections (For Migration by Super Admin) ---
    match /owners/{userId} {
        allow read, write: if isSuperAdmin();
    }
    match /billboard_announcements/{docId} {
        allow read, write: if isSuperAdmin();
    }
    match /payments/{paymentId} {
        allow read, write: if isSuperAdmin();
    }
    match /config/{docId} {
        allow read: if isSignedIn(); 
        allow write: if isSuperAdmin();
    }
    match /financial_statements/{statementId} {
        allow read, write: if isSuperAdmin();
    }
     match /unidades/{docId} {
      allow read, write: if isSuperAdmin();
    }
    match /debts/{docId} {
      allow read, write: if isSuperAdmin();
    }
    match /published_reports/{docId} {
      allow read, write: if isSuperAdmin();
    }
    match /app_feedback/{docId} {
      allow read, write: if isSuperAdmin();
    }
    match /integral_reports/{docId} {
      allow read, write: if isSuperAdmin();
    }


    // --- New Multi-Condo Structure ---

    // The /condominios collection itself
    match /condominios/{condoId} {
      // Allows reading the condo's main document if signed in. This is needed for login and gatekeeper.
      allow read: if true;
      allow list: if false; // Deny listing all condos.
      allow write: if isSuperAdmin(); // Only super admin can create/update condo documents.

      // --- Subcollections within a condo ---
      
      // OWNERS subcollection
      match /owners/{userId} {
        // Admins can read any profile in their condo. Owners can read their own.
        allow read: if isSuperAdmin() || isAdmin(condoId) || isOwner(userId);
        
        // Admins can write to any profile. Owners can update their own (for avatar, etc).
        allow write: if isSuperAdmin() || isAdmin(condoId);
        allow update: if isOwner(userId);
      }
      
      // CONFIG subcollection
      match /config/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin() || isAdmin(condoId);
      }
      
      // DEBTS subcollection
      match /debts/{debtId} {
        // Admins can manage all debts. Owners can only read their own.
        allow write: if isSuperAdmin() || isAdmin(condoId);
        allow read: if isSuperAdmin() || isAdmin(condoId) || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      }
      
      // PAYMENTS subcollection
      match /payments/{paymentId} {
        allow read, write: if isSuperAdmin() || isAdmin(condoId);
        allow create: if isSignedIn();
        // Owners can read payments where they are a beneficiary.
        allow read: if isSignedIn() && request.auth.uid in resource.data.beneficiaryIds;
      }
      
      // Other generic subcollections
      match /billboard_announcements/{docId} {
          allow read: if isSignedIn();
          allow write: if isSuperAdmin() || isAdmin(condoId);
      }
      match /logs/{docId} {
        allow read: if isSuperAdmin() || isAdmin(condoId);
        allow create: if isSignedIn();
        allow update, delete: if false;
      }
      match /certificates/{docId} {
        allow read, write: if isSuperAdmin() || isAdmin(condoId);
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      }
      match /financial_statements/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin() || isAdmin(condoId);
      }
       match /expenses/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin() || isAdmin(condoId);
      }
      match /published_reports/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin() || isAdmin(condoId);
      }
      match /petty_cash_replenishments/{docId} {
          allow read, write: if isSuperAdmin() || isAdmin(condoId);
      }
       match /cajaChica_movimientos/{docId} {
        allow read, write: if isSuperAdmin() || isAdmin(condoId);
      }
      match /cajaChica_reposiciones/{docId} {
        allow read, write: if isSuperAdmin() || isAdmin(condoId);
      }
      match /surveys/{docId} {
        allow read: if isSignedIn();
        allow create, delete: if isSuperAdmin() || isAdmin(condoId);
        allow update: if isSignedIn(); // Allows owners to update results when voting
      }
      match /survey_responses/{docId} {
        allow read: if isSuperAdmin() || isAdmin(condoId) || (isSignedIn() && resource.data.userId == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if isSuperAdmin() || isAdmin(condoId);
      }
      match /app_feedback/{docId} {
        allow create: if isSignedIn();
        allow read, delete: if isSuperAdmin() || isAdmin(condoId);
        allow update: if false;
      }
      match /admin_tasks/{docId} {
        allow read, write: if isSuperAdmin() || isAdmin(condoId);
      }

    }

    // Collection for super admin management
    match /system_management/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }
  }
}
