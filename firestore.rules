rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE SEGURIDAD CORREGIDAS ---
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'vallecondo@gmail.com';
    }

    // Verifica si el usuario es admin en CUALQUIERA de las dos colecciones posibles
    function isCondoAdmin(condoId) {
      let isOwnersAdmin = exists(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid)) &&
                           get(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid)).data.role == 'admin';
      let isPropietariosAdmin = exists(/databases/$(database)/documents/condominios/$(condoId)/propietarios/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/condominios/$(condoId)/propietarios/$(request.auth.uid)).data.role == 'admin';
      return request.auth != null && (isOwnersAdmin || isPropietariosAdmin);
    }

    // Verifica si el usuario existe en CUALQUIERA de las dos colecciones
    function isCondoOwner(condoId) {
      return request.auth != null && 
        (exists(/databases/$(database)/documents/condominios/$(condoId)/owners/$(request.auth.uid)) ||
         exists(/databases/$(database)/documents/condominios/$(condoId)/propietarios/$(request.auth.uid)));
    }

    // --- REGLA MAESTRA SUPER ADMIN ---
    match /{allPaths=**} {
      allow read, write: if isSuperAdmin();
    }

    // --- COLECCIÓN DE CONDOMINIOS ---
    match /condominios/{condoId} {
      
      allow read: if request.auth != null;

      // Perfiles de Propietarios (Estructura Antigua para condo_01)
      match /owners/{ownerId} {
        allow read: if request.auth != null && (request.auth.uid == ownerId || isCondoAdmin(condoId));
        allow write: if isCondoAdmin(condoId);
      }

      // Perfiles de Propietarios (Estructura Nueva para los demás)
      match /propietarios/{ownerId} {
        allow read: if request.auth != null && (request.auth.uid == ownerId || isCondoAdmin(condoId));
        allow write: if isCondoAdmin(condoId);
      }

      // DEUDAS (Debts)
      match /debts/{debtId} {
        allow read: if isCondoAdmin(condoId) || (request.auth != null && resource.data.ownerId == request.auth.uid);
        allow write: if isCondoAdmin(condoId);
      }

      // PAGOS (Payments)
      match /payments/{paymentId} {
        allow read: if isCondoAdmin(condoId) || (request.auth != null && request.auth.uid in resource.data.beneficiaryIds);
        allow create: if request.auth != null; 
        allow update, delete: if isCondoAdmin(condoId);
      }

      // CARTELERA (Billboard)
      match /billboard_announcements/{annId} {
        allow read: if request.auth != null; 
        allow write: if isCondoAdmin(condoId);
      }

      // CONFIGURACIÓN (Rooted en workingCondoId/activeCondoId)
      match /{allChildren=**} {
        allow read: if isCondoAdmin(condoId) || isCondoOwner(condoId);
        allow write: if isCondoAdmin(condoId);
      }
    }
  }
}
