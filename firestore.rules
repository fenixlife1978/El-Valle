rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin.
    // It reads the user's profile from the 'owners' collection.
    function isAdmin(userId) {
      return get(/databases/$(database)/documents/owners/$(userId)).data.role == 'administrador';
    }

    // Default rule: Deny all reads and writes unless explicitly allowed.
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Admins have full access to all collections.
    match /{path=**} {
        allow read, write: if isAdmin(request.auth.uid);
    }

    // Rules for the 'owners' collection
    match /owners/{userId} {
      // Owners can read their own profile.
      allow get: if request.auth.uid == userId;
      // Owners can update their own profile.
      allow update: if request.auth.uid == userId;
      // Nobody can create or delete owner profiles directly except admins (covered by global admin rule).
      allow create, delete: if false;
    }

    // Rules for the 'payments' collection
    match /payments/{paymentId} {
      // Owners can read payments where they are listed as a beneficiary.
      allow read: if request.auth.uid in resource.data.beneficiaryIds;
      // Authenticated users can create new payment reports.
      allow create: if request.auth != null;
    }

    // Rules for the 'debts' collection
    match /debts/{debtId} {
        // Owners can read debts that belong to them.
        allow read: if resource.data.ownerId == request.auth.uid;
    }

    // Rules for the 'historical_payments' collection
    match /historical_payments/{paymentId} {
        // Owners can read historical payments that belong to them.
        allow read: if resource.data.ownerId == request.auth.uid;
    }

    // Rules for the 'config' collection
    match /config/{configId} {
      // All authenticated users can read the system configuration (e.g., for exchange rates).
      allow get: if request.auth != null;
    }
  }
}
